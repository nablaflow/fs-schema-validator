#!/usr/bin/env python

import sys
from pathlib import Path

import pydantic

from fs_schema_validator import Schema

if __name__ == '__main__':
    with open(sys.argv[1]) as f:
        try:
            schema = Schema.from_yaml(f)
        except pydantic.ValidationError as e:
            print(f"❗️ The provided schema is invalid!")
            print()
            print(e)
            sys.exit(127)

    report = schema.validate_(root_dir=Path.cwd())

    for valid_path in report.valid_paths:
        print(f"✅ {valid_path}")

    if len(report.errors) == 0:
        sys.exit(0)

    for path, reasons in report.grouped_by_path():
        print(f"❗️ {path}")

        print("     reasons:")
        for reason in reasons:
            print(f"     - {reason}")

    sys.exit(1)
